<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DSR Chat</title>

<style>
body{
margin:0;
font-family:sans-serif;
background:#0d0d0d;
color:white;
display:flex;
height:100vh;
}

/* LOGIN */
.login{
position:fixed;
width:100%;
height:100%;
display:flex;
justify-content:center;
align-items:center;
background:#000;
z-index:10;
}

.box{
background:#111;
padding:20px;
border-radius:10px;
text-align:center;
width:90%;
max-width:260px;
}

input{
width:100%;
padding:8px;
margin:6px 0;
border:none;
border-radius:6px;
font-size:13px;
}

button{
padding:7px;
border:none;
border-radius:6px;
background:#00ffcc;
cursor:pointer;
font-size:12px;
}

/* SIDEBAR */
.sidebar{
width:200px;
background:#111;
overflow-y:auto;
}

/* CHAT */
.chat{
flex:1;
display:flex;
flex-direction:column;
height:100vh;
}

.header{
padding:8px;
background:#111;
display:flex;
justify-content:space-between;
align-items:center;
font-size:12px;
}

.messages{
flex:1;
overflow-y:auto;
padding:6px;
}

.msg{
background:#1f1f1f;
padding:7px;
border-radius:8px;
margin:4px;
max-width:65%;
font-size:12px;
}

.me{
background:#00ffcc;
color:black;
margin-left:auto;
}

.time{
font-size:8px;
text-align:right;
}

.input{
display:flex;
padding:6px;
background:#111;
}

.input input{
flex:1;
font-size:12px;
}

.input button{
padding:5px 8px;
}

.user{
padding:7px;
border-bottom:1px solid #222;
cursor:pointer;
font-size:12px;
}

/* üì± MOBILE FIX (IMPORTANT) */
@media(max-width:700px){

body{
flex-direction:column;
height:100vh;
}

/* users top bar */
.sidebar{
width:100%;
height:60px;
display:flex;
overflow-x:auto;
overflow-y:hidden;
}

/* users */
.user{
min-width:80px;
text-align:center;
font-size:10px;
}

/* chat takes rest */
.chat{
flex:1;
height:auto;
}

.messages{
height:calc(100vh - 140px);
}

.msg{
max-width:90%;
}

}
</style>
</head>

<body>

<div class="login" id="login">
<div class="box">
<h2 style="font-size:16px;">DSR Chat</h2>
<input id="name" placeholder="Enter username">
<button id="enterBtn">Enter</button>
</div>
</div>

<div class="sidebar" id="users"></div>

<div class="chat">
<div class="header">
<span id="chatName">Select Chat</span>
<span id="onlineCount"></span>
<button id="logoutBtn">Logout</button>
</div>

<div style="padding:6px;background:#111;font-size:11px;">
üë§ You: <b id="myName"></b>
</div>

<div id="notice" style="text-align:center;color:#00ffcc;font-size:11px;"></div>

<div class="messages" id="messages"></div>

<div class="input">
<input id="msg" placeholder="Type message">
<button id="sendBtn">Send</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore,collection,addDoc,onSnapshot,doc,setDoc,
updateDoc,deleteDoc,query,orderBy,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyBGIE6NhM9g3cRJm-GJS2lWEPZbH7zFLDA",
authDomain:"dsr-chat4.firebaseapp.com",
projectId:"dsr-chat4",
storageBucket:"dsr-chat4.firebasestorage.app",
messagingSenderId:"886435031733",
appId:"1:886435031733:web:ca7359cc950fe35a76ecfc"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let username=localStorage.getItem("user")||"";
let userId=localStorage.getItem("id")||Date.now()+"";
let currentChat="";

window.onload=()=>{
const nameInput=document.getElementById("name");
const msgInput=document.getElementById("msg");

nameInput.addEventListener("keydown",e=>{
if(e.key==="Enter") start();
});

msgInput.addEventListener("keydown",e=>{
if(e.key==="Enter") send();
});

enterBtn.onclick=start;
sendBtn.onclick=send;
logoutBtn.onclick=logout;

if(username){
login.style.display="none";
init();
}
};

function start(){
username=document.getElementById("name").value.trim();
if(!username) return;

localStorage.setItem("user",username);
localStorage.setItem("id",userId);

login.style.display="none";
init();
}

async function init(){

document.getElementById("myName").innerText=username;

await setDoc(doc(db,"users",userId),{
name:username,online:true,banned:false
});

onSnapshot(doc(db,"users",userId),(d)=>{
if(d.data()?.banned){
alert("You are banned");
logout();
}
});

onSnapshot(collection(db,"users"),snap=>{
let html="";
let online=0;

snap.forEach(d=>{
let u=d.data();
if(u.online) online++;

html+=`<div class="user" onclick="openChat('${d.id}','${u.name}')">
${u.name} ${u.online?"üü¢":""}
</div>`;
});

users.innerHTML=html;
onlineCount.innerText="Online: "+online;
});

onSnapshot(doc(db,"admin","notice"),d=>{
notice.innerText=d.data()?.text||"";
});
}

function cid(a,b){return[a,b].sort().join("_")}

window.openChat=(id,name)=>{
currentChat=cid(userId,id);
chatName.innerText=name;

onSnapshot(query(collection(db,"messages",currentChat,"msgs"),orderBy("time")),
snap=>{
let html="";
snap.forEach(docu=>{
let m=docu.data();
let t=m.time?.toDate().toLocaleTimeString();

html+=`
<div class="msg ${m.sender===username?"me":""}">
${m.text||""}
<div class="time">${t||""}</div>
${m.sender===username?`<button onclick="del('${docu.id}')">‚ùå</button>`:""}
</div>`;
});
messages.innerHTML=html;
});
};

function send(){
const input=document.getElementById("msg");
if(!input.value || !currentChat)return;

addDoc(collection(db,"messages",currentChat,"msgs"),{
sender:username,
text:input.value,
time:serverTimestamp()
});

input.value="";
}

window.del=(id)=>{
deleteDoc(doc(db,"messages",currentChat,"msgs",id));
}

function logout(){
localStorage.clear();
location.reload();
}

</script>

</body>
</html>
