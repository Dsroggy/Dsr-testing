<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DSR Chat</title>

<style>
body{
margin:0;
font-family:sans-serif;
background:#0d0d0d;
color:white;
display:flex;
height:100vh;
}

/* LOGIN */
.login{
position:fixed;
width:100%;
height:100%;
display:flex;
justify-content:center;
align-items:center;
background:#000;
z-index:10;
}

.box{
background:#111;
padding:20px;
border-radius:10px;
width:90%;
max-width:260px;
text-align:center;
}

input{
width:100%;
padding:8px;
margin:6px 0;
border:none;
border-radius:6px;
font-size:13px;
}

button{
padding:7px;
border:none;
border-radius:6px;
background:#00ffcc;
cursor:pointer;
font-size:12px;
}

/* SIDEBAR */
.sidebar{
width:200px;
background:#111;
overflow-y:auto;
}

/* CHAT */
.chat{
flex:1;
display:flex;
flex-direction:column;
height:100vh;
}

.header{
padding:8px;
background:#111;
display:flex;
justify-content:space-between;
font-size:12px;
}

.messages{
flex:1;
overflow-y:auto;
padding:6px;
}

.msg{
background:#1f1f1f;
padding:7px;
border-radius:8px;
margin:4px;
max-width:65%;
font-size:12px;
}

.me{
background:#00ffcc;
color:black;
margin-left:auto;
}

.time{
font-size:8px;
text-align:right;
}

.input{
display:flex;
padding:8px;
background:#111;
gap:5px;
}

.input input{
flex:1;
font-size:12px;
}

.user{
padding:7px;
border-bottom:1px solid #222;
cursor:pointer;
font-size:12px;
}

/* MOBILE */
@media(max-width:700px){
body{flex-direction:column;}
.sidebar{
width:100%;
height:60px;
display:flex;
overflow-x:auto;
}
.user{
min-width:80px;
text-align:center;
font-size:10px;
}
.chat{
height:calc(100vh - 60px);
}
.msg{
max-width:90%;
}
}
</style>
</head>

<body>

<div class="login" id="login">
<div class="box">
<h3>DSR Chat</h3>
<input id="name" placeholder="Enter username">
<button id="enterBtn">Enter</button>
</div>
</div>

<div class="sidebar" id="users"></div>

<div class="chat">
<div class="header">
<span id="chatName">Select Chat</span>
<span id="onlineCount"></span>
<button id="logoutBtn">Logout</button>
</div>

<div style="padding:5px;background:#111;font-size:11px;">
ðŸ‘¤ You: <b id="myName"></b>
</div>

<div id="notice" style="text-align:center;color:#00ffcc;font-size:11px;"></div>

<div class="messages" id="messages"></div>

<div class="input">
<input id="msg" placeholder="Type message">
<button id="sendBtn">Send</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore,collection,addDoc,onSnapshot,doc,setDoc,
query,orderBy,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyBGIE6NhM9g3cRJm-GJS2lWEPZbH7zFLDA",
authDomain:"dsr-chat4.firebaseapp.com",
projectId:"dsr-chat4",
storageBucket:"dsr-chat4.firebasestorage.app",
messagingSenderId:"886435031733",
appId:"1:886435031733:web:ca7359cc950fe35a76ecfc"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let username=localStorage.getItem("user")||"";
let userId=localStorage.getItem("id")||Date.now()+"";
let currentChat="";

/* DOM READY */
window.addEventListener("DOMContentLoaded",()=>{

const nameInput=document.getElementById("name");
const msgInput=document.getElementById("msg");
const sendBtn=document.getElementById("sendBtn");
const enterBtn=document.getElementById("enterBtn");
const logoutBtn=document.getElementById("logoutBtn");

/* EVENTS (MAIN FIX) */
enterBtn.addEventListener("click",start);
sendBtn.addEventListener("click",send);
logoutBtn.addEventListener("click",logout);

nameInput.addEventListener("keydown",e=>{
if(e.key==="Enter") start();
});

msgInput.addEventListener("keydown",e=>{
if(e.key==="Enter") send();
});

/* AUTO LOGIN */
if(username){
login.style.display="none";
init();
}

});

/* START */
function start(){
username=document.getElementById("name").value.trim();
if(!username) return;

localStorage.setItem("user",username);
localStorage.setItem("id",userId);

login.style.display="none";
init();
}

/* SEND (FINAL FIXED) */
function send(){
const input=document.getElementById("msg");

if(!input.value.trim() || !currentChat){
console.log("No chat selected or empty msg");
return;
}

addDoc(collection(db,"messages",currentChat,"msgs"),{
sender:username,
text:input.value.trim(),
time:serverTimestamp()
});

input.value="";
}

/* LOGOUT */
function logout(){
localStorage.clear();
location.reload();
}

/* INIT */
async function init(){

document.getElementById("myName").innerText=username;

await setDoc(doc(db,"users",userId),{
name:username,online:true
});

onSnapshot(collection(db,"users"),snap=>{
let html="";
let online=0;

snap.forEach(d=>{
let u=d.data();
if(u.online) online++;

html+=`<div class="user" onclick="openChat('${d.id}','${u.name}')">
${u.name} ${u.online?"ðŸŸ¢":""}
</div>`;
});

users.innerHTML=html;
onlineCount.innerText="Online: "+online;
});

}

/* CHAT */
function cid(a,b){return[a,b].sort().join("_")}

window.openChat=(id,name)=>{
currentChat=cid(userId,id);
chatName.innerText=name;

onSnapshot(query(collection(db,"messages",currentChat,"msgs"),orderBy("time")),
snap=>{
let html="";
snap.forEach(docu=>{
let m=docu.data();

html+=`
<div class="msg ${m.sender===username?"me":""}">
${m.text}
</div>`;
});
messages.innerHTML=html;
});
};

</script>

</body>
</html>
